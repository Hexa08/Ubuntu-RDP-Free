name: Ubuntu SSH via Ngrok (8 hours uptime)

on: workflow_dispatch

jobs:
  ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours

    steps:
      - name: Setup SSH server and user
        run: |
          sudo apt update
          sudo apt install -y openssh-server wget unzip jq net-tools

          sudo systemctl enable ssh
          sudo systemctl start ssh

          sudo useradd -m hydra
          echo "hydra:root@hydra" | sudo chpasswd
          echo "hydra" | sudo tee /etc/hostname
          sudo hostnamectl set-hostname hydra

          sudo sed -i '/^PasswordAuthentication/d' /etc/ssh/sshd_config
          sudo sed -i '/^PubkeyAuthentication/d' /etc/ssh/sshd_config
          echo "PasswordAuthentication yes" | sudo tee -a /etc/ssh/sshd_config
          echo "PubkeyAuthentication no" | sudo tee -a /etc/ssh/sshd_config

          sudo systemctl restart ssh

      - name: Install and start ngrok TCP tunnel
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          sudo mv ngrok /usr/local/bin
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          nohup ngrok tcp 22 &

      - name: Show SSH connection details
        run: |
          sleep 15
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          HOST=$(echo $NGROK_URL | sed -e 's/tcp:\/\///' | cut -d ":" -f 1)
          PORT=$(echo $NGROK_URL | cut -d ":" -f 3)
          echo ""
          echo "‚úÖ SSH Server is ready!"
          echo "------------------------------------"
          echo "üåê Host/IP: $HOST"
          echo "üîå Port:    $PORT"
          echo "üë§ User:    hydra"
          echo "üîë Pass:    root@hydra"
          echo "------------------------------------"
          echo ""
          echo "üîó Connect using SSH command:"
          echo "ssh hydra@$HOST -p $PORT"

      - name: Keep job alive for 8 hours
        run: |
          SECONDS=0
          while [ $SECONDS -lt 28800 ]; do
            sleep 60
          done

      - name: Run apt update before finishing
        run: |
          echo "Time is up! Running apt update before exit."
          sudo apt update
